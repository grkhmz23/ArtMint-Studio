generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Draft {
  id          String   @id @default(cuid())
  prompt      String
  preset      String?
  templateId  String?
  variations  String   // JSON array of Variation objects
  selectedIdx Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Mint {
  id           String   @id @default(cuid())
  mintAddress  String   @unique
  inputJson    String   // Canonical input JSON
  hash         String
  imageUrl     String
  animationUrl String
  metadataUrl  String
  title        String?
  wallet       String
  createdAt    DateTime @default(now())
  listing      Listing?
}

model Listing {
  id            String   @id @default(cuid())
  mintAddress   String   @unique
  priceLamports BigInt
  status        String   @default("pending") // pending, active, sold, cancelled
  txSignature   String?
  saleStateKey  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  mint          Mint     @relation(fields: [mintAddress], references: [mintAddress])
}

// ── Auth ─────────────────────────────────────────────────────────────────────

model AuthNonce {
  id        String   @id @default(cuid())
  nonce     String   @unique
  wallet    String?  // set once claimed by verify
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  wallet    String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// ── Usage quotas & rate limiting ─────────────────────────────────────────────

model UsageCounter {
  id         String   @id @default(cuid())
  date       String   // YYYY-MM-DD
  userWallet String
  action     String   // e.g. "ai_variation", "mint"
  count      Int      @default(0)
  updatedAt  DateTime @updatedAt

  @@unique([date, userWallet, action])
}

model RateLimitWindow {
  id          String   @id @default(cuid())
  key         String   // e.g. "ai:ip:1.2.3.4" or "ai:wallet:abc..."
  windowStart DateTime
  count       Int      @default(0)
  updatedAt   DateTime @updatedAt

  @@unique([key])
}

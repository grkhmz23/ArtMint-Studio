generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Draft {
  id        String   @id @default(cuid())
  wallet    String
  type      String   @default("ai") // "ai" | "code" | "manual"
  title     String?
  data      String   // JSON blob with type-specific data
  imageUrl  String?  // preview thumbnail URL or data URL
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([wallet])
}

model Mint {
  id            String   @id @default(cuid())
  mintAddress   String   @unique
  inputJson     String   // Canonical input JSON
  hash          String
  imageUrl      String
  animationUrl  String
  metadataUrl   String
  title         String?
  wallet        String
  txSignature   String?  @unique // On-chain tx sig — unique to prevent replay
  status        String   @default("pending") // pending, confirmed
  createdAt     DateTime @default(now())
  listing       Listing?
  
  // Relations
  favorites     Favorite[]
  activities    Activity[]
  collectionItems CollectionItem[]
  offers        Offer[]
  auction       Auction?

  @@index([wallet])
  @@index([status])
  @@index([createdAt])
}

model Listing {
  id            String   @id @default(cuid())
  mintAddress   String   @unique
  priceLamports BigInt
  status        String   @default("pending") // pending, active, sold, cancelled
  txSignature   String?
  saleStateKey  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  mint          Mint     @relation(fields: [mintAddress], references: [mintAddress])

  @@index([status])
}

// ── Auth ─────────────────────────────────────────────────────────────────────

model AuthNonce {
  id        String   @id @default(cuid())
  nonce     String   @unique
  wallet    String?  // set once claimed by verify
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([expiresAt])
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  wallet    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([wallet])
  @@index([expiresAt])
}

// ── Usage quotas & rate limiting ─────────────────────────────────────────────

model UsageCounter {
  id         String   @id @default(cuid())
  date       String   // YYYY-MM-DD
  userWallet String
  action     String   // e.g. "ai_variation", "mint"
  count      Int      @default(0)
  updatedAt  DateTime @updatedAt

  @@unique([date, userWallet, action])
}

model RateLimitWindow {
  id          String   @id @default(cuid())
  key         String   // e.g. "ai:ip:1.2.3.4" or "ai:wallet:abc..."
  windowStart DateTime
  count       Int      @default(0)
  updatedAt   DateTime @updatedAt

  @@unique([key])
}

// ── Social Features ──────────────────────────────────────────────────────────

model Favorite {
  id          String   @id @default(cuid())
  wallet      String
  mintAddress String
  createdAt   DateTime @default(now())

  mint        Mint     @relation(fields: [mintAddress], references: [mintAddress], onDelete: Cascade)

  @@unique([wallet, mintAddress])
  @@index([wallet])
  @@index([mintAddress])
}

model Follow {
  id          String   @id @default(cuid())
  followerWallet  String
  followingWallet String
  createdAt   DateTime @default(now())

  @@unique([followerWallet, followingWallet])
  @@index([followerWallet])
  @@index([followingWallet])
}

model Activity {
  id          String   @id @default(cuid())
  type        String   // "mint", "listing", "sale", "purchase", "favorite"
  wallet      String   // Actor wallet
  targetWallet String? // Target wallet (e.g., seller in purchase)
  mintAddress String?
  metadata    String?  // JSON blob with additional data
  createdAt   DateTime @default(now())

  mint        Mint?    @relation(fields: [mintAddress], references: [mintAddress], onDelete: SetNull)

  @@index([wallet])
  @@index([targetWallet])
  @@index([type])
  @@index([createdAt])
}

// ── Collections ───────────────────────────────────────────────────────────────

model Collection {
  id            String   @id @default(cuid())
  slug          String   @unique
  name          String
  description   String?
  imageUrl      String?
  creatorWallet String
  featured      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  items         CollectionItem[]

  @@index([creatorWallet])
  @@index([featured])
}

model CollectionItem {
  id           String   @id @default(cuid())
  collectionId String
  mintAddress  String
  addedAt      DateTime @default(now())

  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  mint         Mint       @relation(fields: [mintAddress], references: [mintAddress], onDelete: Cascade)

  @@unique([collectionId, mintAddress])
  @@index([collectionId])
  @@index([mintAddress])
}

// ── Offers & Auctions ─────────────────────────────────────────────────────────

model Offer {
  id            String   @id @default(cuid())
  mintAddress   String
  buyerWallet   String
  sellerWallet  String
  priceLamports BigInt
  status        String   @default("active") // active, accepted, rejected, expired, cancelled
  expiresAt     DateTime
  txSignature   String?  // Set when offer is accepted and transaction completed
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  mint          Mint     @relation(fields: [mintAddress], references: [mintAddress], onDelete: Cascade)

  @@index([buyerWallet])
  @@index([sellerWallet])
  @@index([mintAddress])
  @@index([status])
  @@index([expiresAt])
}

model Auction {
  id              String   @id @default(cuid())
  mintAddress     String   @unique
  sellerWallet    String
  startPriceLamports BigInt
  reservePriceLamports BigInt?
  minBidIncrement BigInt   @default(50000000) // 0.05 SOL default
  type            String   // "english" | "dutch"
  startTime       DateTime
  endTime         DateTime
  status          String   @default("active") // active, ended, cancelled
  highestBid      BigInt?
  highestBidder   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  mint            Mint     @relation(fields: [mintAddress], references: [mintAddress], onDelete: Cascade)
  bids            Bid[]

  @@index([sellerWallet])
  @@index([status])
  @@index([endTime])
}

model Bid {
  id          String   @id @default(cuid())
  auctionId   String
  bidder      String
  amount      BigInt
  createdAt   DateTime @default(now())

  auction     Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  @@index([auctionId])
  @@index([bidder])
  @@index([createdAt])
}
